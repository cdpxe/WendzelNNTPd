name: Build tests

on:
    workflow_dispatch:
    push:
        branches:

jobs:
  build-test:
    runs-on: ubuntu-latest
    name: Build and Test wendzelnntpd
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/386
          - linux/arm/v5
          - linux/arm/v7
          - linux/arm64/v8
          - linux/ppc64le
          - linux/s390x
        image: [debian:stable-slim]
        include:
          - platform: linux/amd64
            image: ubuntu:latest
          - platform: linux/amd64
            image: fedora:latest
          - platform: linux/amd64
            image: opensuse/leap:latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}
      - name: Install test tools
        run: sudo apt-get update -y && sudo apt-get install -y netcat-openbsd expect
      - run: docker network create --ipv6 ip6net
      - name: Start Docker container
        run: |
          docker run \
            --network ip6net \
            --rm \
            -v $(pwd):${{ github.workspace }} \
            -w ${{ github.workspace }} \
            --platform ${{ matrix.platform }} \
            --name testcontainer \
            -d -it \
            ${{ matrix.image }} \
            /bin/sh
      - name: Install dependencies with apt
        run: docker exec testcontainer bash -c "apt-get update -y && apt-get install -y gcc flex bison sqlite3 libsqlite3-dev mariadb-client libmariadb-dev-compat ca-certificates libmariadb-dev libmhash-dev make openssl libssl-dev procps"
        if: ${{ matrix.image == 'debian:stable-slim' || matrix.image == 'ubuntu:latest' }}
      - name: Install dependencies with dnf
        run: docker exec testcontainer bash -c "dnf -y update && dnf -y install gcc flex bison sqlite sqlite-devel mariadb-connector-c-devel ca-certificates mhash-devel make openssl openssl-devel procps-ng"
        if: ${{ matrix.image == 'fedora:latest' }}
      - name: Install dependencies with zypper
        run: docker exec testcontainer bash -c "zypper install -y gcc flex bison sqlite3 sqlite3-devel libmariadb-devel ca-certificates mhash-devel make openssl libopenssl-devel procps"
        if: ${{ matrix.image == 'opensuse/leap:latest' }}
      - name: configure
        run: docker exec testcontainer bash -c "./configure"
      - name: make
        run: docker exec testcontainer bash -c "make"
      - name: make install
        run: docker exec testcontainer bash -c "make install"
      - name: Setup ssl certificates
        run: docker exec testcontainer bash -c "./create_certificate --environment local"
      - name: Initialize test data
        run: docker exec testcontainer bash -c "cd unittesting/tls-testing && ./initialize_db.sh && cp test-files/wendzelnntpd.conf /usr/local/etc/"
      - name: Patch testuser password
        run: docker exec testcontainer bash -c "echo \"update users set password = 'c336f7d5bab8ccf4860fc53cb33290bb794d481590db02c0936fbaa74099c77d' where name = 'testuser'\" | sqlite3 /var/spool/news/wendzelnntpd/usenet.db"
        if: ${{ !(matrix.platform == 'linux/amd64' || matrix.platform == 'linux/386') }}
      - name: run wendzelnntpd
        run: docker exec testcontainer bash -c "wendzelnntpd -d"
      - name: Copy certificates from container to host
        run: cd unittesting/tls-testing && mkdir tmp && docker cp testcontainer:/usr/local/etc/ssl/ca.crt tmp/ca-self.crt && docker cp testcontainer:/usr/local/etc/ssl/ca-key.pem tmp/ca-self.key
      - name: Create client cert for mutual tls tests
        run: cd unittesting/tls-testing && ./create-client-cert.sh
      - name: get container ipv4
        run: echo "ipv4=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' testcontainer)" >> $GITHUB_ENV
      - name: get container ipv6
        run: echo "ipv6=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.GlobalIPv6Address}}{{end}}' testcontainer)" >> $GITHUB_ENV
      - name: Smoketest IPv4
        run: netcat ${{ env.ipv4 }} 119 -w 1
      - name: Smoketest IPv6
        run: netcat ${{ env.ipv6 }} 119 -w 1
      - name: expect tests IPv4
        run: cd unittesting/tls-testing && nntp_address=${{ env.ipv4 }} ./run.sh
      - name: expect tests IPv6
        run: cd unittesting/tls-testing && nntp_address=${{ env.ipv6 }} ./run.sh
      - name: Enable mandatory tls
        run: docker exec testcontainer bash -c "echo \"tls-is-mandatory\" >> /usr/local/etc/wendzelnntpd.conf && pkill -9 wendzelnntpd && wendzelnntpd -d"
      - name: expect test for mandatory tls
        run: cd unittesting/tls-testing && nntp_address=${{ env.ipv4 }} expect tests/special/nntp-mandatory-tls-test.exp
      - name: Stop Docker container
        run: docker stop testcontainer -t 1
